<!--
author: 不惑-农佳武
date: 2017-02-25
title: 工作流表单设计器设计文档 v1.0.0 （一、总体框架设计）
tags: 系统设计
category: 其它 
status: publish 
summary: 工作流表单设计器设计文档 v1.0.0，参考金蝶K3 BOS的系统实现对工作流表单设计器的功能进行分析设计
-->
表单设计器集成环境， 主要由以下两部分构成

+ 设计器
+ 主控台

设计器（以下简称IF, Intelligent Form）用于定义业务模型，创建工作流表单，设置流程等功能；主控台（以下简称CP, Control Panel）用于系统发布（也可以是打包为移动端或pc端的安装包），浏览已经发布的插件或表单系统。


##表单设计的流程
----------------------

1. 指定数据指向的数据库
2. ```业务模型定义```
3. ```表单设计```
4. 流程设计
5. 报表设计
6. ```保存表单，测试```
7. ```发布、部署、导出```

**其中强调部分为一期要实现的功能，即2、3、6、7为确定可以满足一期需求的方案**

**（0303和纯庆讨论后，确定2、3、6、7基本可以满足，其中6的测试、7的导出可以暂时不做)**

###A00. 创建帐套
帐套的创建相当于人为地将不同帐户的单据区分开来（可以理解为新初始化了不同的数据库），这里可以先有这么个设计上的考虑，可以后续再补充

###A01. 定义业务模型
**业务模型定义**要经历以下几个过程：

|步骤|阶段|描述|
|:------:|:----|:----|
|1| 调研| 即由业务人员与需求方进行沟通，最简单的场景是将原先用于录入的纸质表单拿到，了解具体的业务过程，表单审批过程，作为建模及流程图绘制的依据|
|2| 创建子系统| 针对业务需求新建子系统，为子系统定义相应的编号，名字，应用场景等|
|3| 基础资料定义| 基础资料在这里指的是一个字典表，供表单中的字段读取， 例如```费用```字段可以分为几种类型：水电费、房费、宽带费等，这些取值则可以由定义的基础资料处获取|
|4| 表单字段定义| 确定每个字段的类型，表单的展示方式后，即可以进行字段的定义，其实也就是数据表字段的定义。如费用可以用下拉列表进行展示，那么这一字段的label可以定义为varchar类型，长度为50个字符，字段的值类型为int类型，长度为2，允许非空等**（这块其实相当于生成sql时增加的字段定义, create table \`if_200001\` if not exists ( id int(11) not null auto_increment primary key, name varchar(255), label varchar(50), value int(2)) InnoDB charset='utf-8';)**|
|5| 规则定义| 如我们有需求是对一个字段进行非空检验，最大最小值校验，数据格式校验，几个字段的级联运算，对字段进行锁定或显示隐藏，或是对字段的取值进行条件的限制等，这个时候就需要定义一系列的规则，满足条件的则触发相应的事件加以执行，否则提示错误信息|


###A02. 表单设计
以下的**组件**和上述的**字段**含义一致，称为组件只是从ui的角度对其进行描述

|步骤|阶段|描述|
|:------:|:----|:----|
|1| 表单组件设计| 根据之前的业务模型定义，通过拖拽布局控件进行表单的界面设计。组件分为两类：```基础组件```和```容器组件```。容器组件如表格、选项卡、折叠组件等，可以用于承载基础组件；基础组件如输入框、小数、整数、电话、下拉框、日期、制表人、审核人等|
|2| 组件布局样式设置| 可以对组件进行对齐、居中、字体、描述、主题等进行设置，让组件更整齐美观|
|3| 组件基础属性设置| 可以对组件的缺省值、可见性、锁定性、是否必录等属性进行设置|
|4| 组件关联属性设置| 可以对组件的关联组件（或称为字段）进行设置，主要用于组件的级联更新|
|5| 组件事件属性设置| 对组件的事件属性进行设置，提供如下几个事件钩子：表单加载时，组件值更新时，保存的规则检验等|
|6| 表单属性设置| 这个类似组件的属性设置，不过是在表单维度的属性维护，提供如下几个事件钩子：表单操作前、操作时、操作后|

新建表单时，系统会默认为表单（主表）增加一个表体（即从表），表体字段用于展示详细的分录（分录是会计上的叫法，在这里其实可以认为是能够实现自动运算功能的表单组件），表体用于实现数据项运算及汇总功能

```在开放了插件功能可以对外提供二次开发功能以后，可以对中间层插件扩展以下事件钩子：表单保存前、后的事件，表单删除前、后的事件，表单审核前、后的事件及整单加载的事件```


[v1.0.0系统的数据模型定义见这里](http://172.16.1.15:8080/blog/IntelliForm/FieldDefinitions.html)

[v1.0.0系统提供的组件见这里](http://172.16.1.15:8080/blog/IntelliForm/CompontList.html)

[v1.0.0系统支持的事件列表见这里](http://172.16.1.15:8080/blog/IntelliForm/EventList.html)


###A03. 流程设计
流程设计先借用activiti现有的流程定义功能，这个版本只需要关注表单设计完成之后，表单流转中的各个状态如何与流程节点关联起来

###A04. 报表设计
todo...

###A05. 保存表单，测试
表单第一次保存后， 会根据业务模型建立物理表，测试的过程则是对表、字段进行测试，检查表和字段是否缺失，基础资料是否可以取到等; 其次是对流程进行测试，分为两步：流程测试；业务对象和流程的关联测试


###A06. 发布、部署、导出
####发布
CP可以对以下项进行发布

* 表单
* ```插件(暂不实现)```

表单发布到activiti工作流引擎后，这个工作流得以启动，发布后可以选择包的部署和导出
在这里，发布出来的格式是经转换后activiti可识别的表单格式

####部署

因为部署直接将表单以web的形式发布并部署到CP，在CP内置运行环境里查看效果

####导出
导出则是将测试通过的工作流表单打包成移动端安装包或pc端执行文件，第一个版本将支持web版本的发布及pc端执行文件的生成，其中pc端生成文件以 electron或node-webkit实现

如何解决Web -> App的生成？目前有以下两种方式可以尝试
1. 实现一个parser.js， 在移动端加载webview/uiwebview时注入，通过parser(FormJson) => renderedFormContent
2. 后续在预研了React和RN的互转后，应该也可以导出为移动端的安装包

（0303和纯庆讨论后，这个可以暂时不做）

##IF
----------------------

设计器界面参考k3，划分为如下几块，功能待整理确定了版本一需求后补充，暂时yy吧。。

+ 菜单栏
+ 工具栏
+ 组件区域
  + 基础组件
  + 容器组件
+ 设计区域
+ 属性区域
+ 配置窗口
+ 状态栏


##CP
----------------------

主控台分为如下几块

+ 登陆界面
+ 子系统
+ 用户管理
+ 系统设置